<!DOCTYPE html>
<html>
<head>
	<title>Live Stream From the Browser</title>
	<script src="socket.io.js"></script>
	<link rel="stylesheet" href="style.css">
	<link rel="icon" href="icon.ico">
</head>

<body>
	<br><label for="optionWidth" class="form">Size:</label>
	<input class="form" type="text" id="optionWidth" value="240" /> &times;
	<input class="form" type="text" id="optionHeight" value="240" />
	<br><br>
	<label class="form" for="optionFramerate">Frame Rate:</label>
	<input class="form" type="text" id="optionFramerate" value="15" />
	<br><br>
	<label class="form" for="optionFramerate">Audio bitrate:</label>
	<select class="form" id="optionBitrate">
		<option value="22050">22050</option>
		<option value="44100">44100</option>
		<option value="11025">11025</option>
	</select>
	<input class="form" type="checkbox" style="display:none" id="checkboxReconnection" checked="true">
	<label class="form" style="display:none">Reconnection </label>
	<br>
	<div class="form">
		Connect the server, then start streaming.
	</div><br />
	<button class="form" id="buttonServer">Connect Server</button>
	<button class="form" id="buttonStart">Start Streaming</button>
	<button class="form" id="buttonStop">Stop Streaming</button>

	<br />
	<hr />

	<h2>Hint: Keep an eye on the status window, the encoding value must stay above 1x, or your stream will start to lag.
		Use a smaller screen size, or change the frame rate in the Constraints variable.
	</h2>

	<div class="video">
		<p id="outputMessage"></p>

		<video id="outputVideo" playsinline muted autoplay></video>
		<svg id="recording" height="50" width="50">
			<circle id="recordingCircle" cx="25" cy="25" r="20" stroke="black" stroke-width="1" fill="gray" />
		</svg>
		<!-- <video id="videoElement" preload="none"></video> -->
	</div>

	<textarea readonly="true" id="outputConsole" rows=15>
</textarea>
	<script>
		function fail(str) { alert(str + "\nUnable to access the camera Please ensure you are on HTTPS and using Firefox or Chrome."); location.replace('http://mozilla.org/firefox'); }

		var outputConsole = document.getElementById('outputConsole'),
			outputMessage = document.getElementById('outputMessage'),
			outputVideo = document.getElementById('outputVideo'),
			socketio_address = '/',
			optionWidth = document.getElementById('optionWidth'),
			optionHeight = document.getElementById('optionHeight'),
			optionFramerate = document.getElementById('optionFramerate'),
			optionBitrate = document.getElementById('optionBitrate'),
			buttonStart = document.getElementById('buttonStart'),
			height = parseInt(optionHeight.value),
			width = parseInt(optionWidth.value),
			framerate = parseInt(optionFramerate.value),
			audiobitrate = parseInt(optionBitrate.value),
			url = 'rtmp://'+location.host.split(':')[0]+':1935/a';

		console.log("framerate", framerate);
		optionHeight.onchange = optionHeight.onkeyup = function () { height = 1 * this.value; }
		optionWidth.onchange = optionWidth.onkeyup = function () { width = 1 * this.value; console.log("width" + width); }
		optionFramerate.onchange = optionFramerate.onkeyup = function () { framerate = 1 * this.value; console.log("framerate" + framerate); }
		optionBitrate.onchange = optionBitrate.onkeyup = function () { audiobitrate = 1 * this.value; console.log("bitrate" + audiobitrate); }
		buttonStart.onclick = requestMedia;
		buttonStop.onclick = stopStream;
		buttonServer.onclick = connectServer;
		var oo = document.getElementById("checkboxReconnection");
		//just start the server
		//connectServer;
		var mediaRecorder;
		var socket;
		var state = "stop";
		console.log("state initiated = " + state);
		var t;
		buttonStart.disabled = true;
		buttonStop.disabled = true;

		function videoShow(stream) {
			if ("srcObject" in outputVideo) {
				outputVideo.muted = true;
				outputVideo.srcObject = stream;

			} else {
				outputVideo.src = window.URL.createObjectURL(stream);
			}
			outputVideo.addEventListener("loadedmetadata", function (e) {
				//console.log(outputVideo);
				outputMessage.innerHTML = "Local video source size:" + outputVideo.videoWidth + "x" + outputVideo.videoHeight;
			}, false);
		}

		function showOutput(str) {
			outputConsole.value += "\n" + str;
			outputConsole.scrollTop = outputConsole.scrollHeight;
		};

		function timedCount() {
			var oo = document.getElementById("checkboxReconnection");
			if (oo.checked) {
				console.log("timed count state = " + state);
				if (state == "ready") {
					console.log("reconnecting and restarting the media stream");
					//do I need to rerun the request media?

					connectServer();
					buttonStart.disabled = false;
					buttonServer.disabled = true;
				}
				else {
					console.log("not ready yet - wating 1000ms");
					t = setTimeout("timedCount()", 1000);
					connectServer();
					outputMessage.innerHTML = "try connect server ...";
					buttonStart.disabled = true;
					buttonServer.disabled = false;
				}
			}
			else {
				//reconnection is off
				console.log("reconnection is off, buttons hcnage and we are done.");
				buttonStart.disabled = true;
				buttonServer.disabled = false;
			}
		}

		function connectServer() {
			navigator.getUserMedia = (navigator.mediaDevices.getUserMedia ||
				navigator.mediaDevices.mozGetUserMedia ||
				navigator.mediaDevices.msGetUserMedia ||
				navigator.mediaDevices.webkitGetUserMedia);
			if (!navigator.getUserMedia) { fail('No getUserMedia() available.'); }
			if (!MediaRecorder) { fail('No MediaRecorder available.'); }

			var socketOptions = { secure: true, reconnection: true, reconnectionDelay: 1000, timeout: 15000, pingTimeout: 15000, pingInterval: 45000, query: { framespersecond: framerate, audioBitrate: audiobitrate } };

			//start socket connection
			socket = io.connect(socketio_address.value, socketOptions);
			// console.log("ping interval =", socket.pingInterval, " ping TimeOut" = socket.pingTimeout);
			//outputMessage.innerHTML=socket;

			socket.on('connect_timeout', (timeout) => {
				console.log("state on connection timeout= " + timeout);
				outputMessage.innerHTML = "Connection timed out";
				recordingCircle.style.fill = 'gray';

			});

            socket.on('error', (error) => {
				console.log("state on connection error= " + error);
				outputMessage.innerHTML = "Connection error";
				recordingCircle.style.fill = 'gray';
			});

			socket.on('connect_error', function () {
				console.log("state on connection error= " + state);
				outputMessage.innerHTML = "Connection Failed";
				recordingCircle.style.fill = 'gray';
			});

			socket.on('message', function (m) {
				console.log("state on message= " + state);
				console.log('recv server message', m);
				showOutput('SERVER:' + m);

			});

			socket.on('fatal', function (m) {

				showOutput('Fatal ERROR: unexpected:' + m);
				//alert('Error:'+m);
				console.log("fatal socket error!!", m);
				console.log("state on fatal error= " + state);
				//already stopped and inactive
				console.log('media recorder restarted');
				recordingCircle.style.fill = 'gray';

				// mediaRecorder.start();
				// state="stop";
				// buttonStart.disabled=true;
				// buttonServer.disabled=false;
				// document.getElementById('buttonStart').disabled=true;　
				//restart the server

				if (oo.checked) {
					//timedCount();
					outputMessage.innerHTML = "server is reload!";
					console.log("server is reloading!");
					recordingCircle.style.fill = 'gray';
				}
				//should reload?
			});

			socket.on('ffmpeg_stderr', function (m) {
				//this is the ffmpeg output for each frame
				showOutput('FFMPEG:' + m);
			});

			socket.on('disconnect', function (reason) {
				console.log("state disconec= " + state);
				showOutput('ERROR: server disconnected!');
				console.log('ERROR: server disconnected!' + reason);
				recordingCircle.style.fill = 'gray';
				//reconnect the server
				connectServer();

				//socket.open();
				//mediaRecorder.stop();
				//state="stop";
				//buttonStart.disabled=true;
				//buttonServer.disabled=false;
				//	document.getElementById('buttonStart').disabled=true;　
				//var oo=document.getElementById("checkboxReconnection");
				if (oo.checked) {
					//timedCount();
					outputMessage.innerHTML = "server is reloading!";
					console.log("server is reloading!");
				}
			});

			state = "ready";
			console.log("state = " + state);
			buttonStart.disabled = false;
			buttonStop.disabled = false;
			buttonServer.disabled = true;
			outputMessage.innerHTML = "connect server successful";
		}

		function requestMedia() {
			var constraints = {
				audio: {
					sampleRate: audiobitrate,
					echoCancellation: true
				},
				video: {
					width: { min: 100, ideal: width, max: 1920 },
					height: { min: 100, ideal: height, max: 1080 },
					frameRate: { ideal: framerate }
				}
			};
			console.log(constraints);
			navigator.mediaDevices.getUserMedia(constraints)
                .then(function (stream) {
                    //let supported = navigator.mediaDevices.getSupportedConstraints();
                    //console.log(supported);
                    videoShow(stream); //only show locally, not remotely
                    recordingCircle.style.fill = 'red';
                    socket.emit('config_rtmpDestination', url);
                    socket.emit('start', 'start');
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start(250);
                    buttonStop.disabled = false;
                    buttonStart.disabled = true;
                    buttonServer.disabled = true;

                    //show remote stream
                    var livestream = document.getElementsByClassName("Livestream");
                    console.log("adding live stream");
                    livestream.innerHtml = "test";

                    mediaRecorder.onstop = function (e) {
                        console.log("stopped!");
                        console.log(e);
                        //stream.stop();
                    }

                    mediaRecorder.onpause = function (e) {
                        console.log("media recorder paused!!");
                        console.log(e);
                        //stream.stop();
                    }

                    mediaRecorder.onerror = function (event) {
                        let error = event.error;
                        console.log("error", error.name);
                    };
                    //document.getElementById('buttonStart').disabled=false;　

                    mediaRecorder.ondataavailable = function (e) {
                        console.log(e.data);
                        socket.emit("binarystream", e.data);
                        state = "start";
                        //chunks.push(e.data);
                    }
                })
                .catch(function (err) {
                    console.log('The following error occured: ' + err);
                    showOutput('Local getUserMedia ERROR:' + err);
                    outputMessage.innerHTML = "Local video source size is not support or No camera?" + outputVideo.videoWidth + "x" + outputVideo.videoHeight;
                    state = "stop";
                    buttonStart.disabled = true;
                    buttonServer.disabled = false;
                });
		}

		function stopStream() {
			console.log("stop pressed:");
			//stream.getTracks().forEach(track => track.stop())
			mediaRecorder.stop();
			recordingCircle.style.fill = 'gray';
			buttonStop.disabled = true;
			buttonStart.disabled = true;
			buttonServer.disabled = false;
		}
	</script>
</body>
</html>